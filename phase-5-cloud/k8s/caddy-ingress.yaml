# Caddy Ingress Controller for Kubernetes
# Provides automatic HTTPS via Let's Encrypt with DuckDNS domain
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: caddy-config
  namespace: default
data:
  Caddyfile: |
    # DuckDNS domain with automatic Let's Encrypt HTTPS
    taskevo.duckdns.org {
      # Better Auth routes -> Frontend (Next.js)
      handle /api/auth/* {
        reverse_proxy todo-app-frontend:3000
      }

      # ChatKit routes -> Frontend (Next.js)
      handle /api/chatkit {
        reverse_proxy todo-app-frontend:3000
      }

      # Other API routes -> Backend (FastAPI)
      handle /api/* {
        reverse_proxy todo-app-backend:8000
      }

      # Health check endpoint
      handle /health {
        rewrite * /api/health
        reverse_proxy todo-app-backend:8000
      }

      # Everything else -> Frontend (Next.js)
      handle {
        reverse_proxy todo-app-frontend:3000
      }

      # Enable compression
      encode gzip zstd

      # Security headers
      header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Referrer-Policy strict-origin-when-cross-origin
      }

      # Logging
      log {
        output stdout
        format console
      }
    }

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: caddy-data
  namespace: default
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: do-block-storage

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: caddy-ingress
  namespace: default
  labels:
    app: caddy-ingress
spec:
  replicas: 1
  selector:
    matchLabels:
      app: caddy-ingress
  template:
    metadata:
      labels:
        app: caddy-ingress
    spec:
      containers:
        - name: caddy
          image: caddy:2-alpine
          ports:
            - containerPort: 80
              name: http
            - containerPort: 443
              name: https
          volumeMounts:
            - name: caddy-config
              mountPath: /etc/caddy/Caddyfile
              subPath: Caddyfile
              readOnly: true
            - name: caddy-data
              mountPath: /data
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
      volumes:
        - name: caddy-config
          configMap:
            name: caddy-config
        - name: caddy-data
          persistentVolumeClaim:
            claimName: caddy-data

---
apiVersion: v1
kind: Service
metadata:
  name: caddy-ingress
  namespace: default
  annotations:
    # DigitalOcean Load Balancer annotations
    service.beta.kubernetes.io/do-loadbalancer-name: "todo-app-lb"
    service.beta.kubernetes.io/do-loadbalancer-protocol: "tcp"
    service.beta.kubernetes.io/do-loadbalancer-healthcheck-port: "80"
    service.beta.kubernetes.io/do-loadbalancer-healthcheck-protocol: "http"
    service.beta.kubernetes.io/do-loadbalancer-healthcheck-path: "/health"
spec:
  type: LoadBalancer
  selector:
    app: caddy-ingress
  ports:
    - name: http
      port: 80
      targetPort: 80
    - name: https
      port: 443
      targetPort: 443
