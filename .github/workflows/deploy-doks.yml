# GitHub Actions workflow for deploying to DigitalOcean Kubernetes (DOKS)
#
# Triggers on:
#   - Push to main branch
#   - Manual trigger via workflow_dispatch
#
# Required GitHub Secrets:
#   - DIGITALOCEAN_ACCESS_TOKEN: DO API token
#   - DATABASE_URL: Neon PostgreSQL connection string
#   - BETTER_AUTH_SECRET: Auth secret key
#   - OPENAI_API_KEY: OpenAI API key

name: Deploy to DOKS

on:
  push:
    branches: [main]
    paths:
      - 'phase-5-cloud/**'
      - '.github/workflows/deploy-doks.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'

env:
  REGISTRY: registry.digitalocean.com/todoappregistry2024
  CLUSTER_NAME: todo-app-cluster

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Login to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 600

      - name: Build and push backend image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/backend:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/backend:latest \
            ./phase-5-cloud/backend
          docker push ${{ env.REGISTRY }}/backend:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/backend:latest

      - name: Build and push frontend image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/frontend:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/frontend:latest \
            ./phase-5-cloud/frontend
          docker push ${{ env.REGISTRY }}/frontend:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/frontend:latest

      - name: Save kubeconfig
        run: |
          doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Deploy to DOKS with Helm
        run: |
          helm upgrade --install todo-app ./phase-5-cloud/helm/todo-app \
            -f ./phase-5-cloud/helm/todo-app/values-doks.yaml \
            --set image.backend.tag=${{ github.sha }} \
            --set image.frontend.tag=${{ github.sha }} \
            --set secrets.DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            --set secrets.BETTER_AUTH_SECRET="${{ secrets.BETTER_AUTH_SECRET }}" \
            --set secrets.OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            --wait \
            --timeout 5m

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/todo-app-frontend --timeout=120s
          kubectl rollout status deployment/todo-app-backend --timeout=120s

      - name: Get deployment info
        run: |
          echo "=== Pods ==="
          kubectl get pods
          echo ""
          echo "=== Services ==="
          kubectl get svc
          echo ""
          echo "=== Access URL ==="
          NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}')
          echo "Application URL: http://$NODE_IP:30080"
