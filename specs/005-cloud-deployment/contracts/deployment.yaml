# Deployment Contract: Cloud Deployment to DigitalOcean
# Feature: 005-cloud-deployment
# Date: 2025-12-04

# This contract defines the expected configuration and behavior
# for deploying the Todo Chatbot to DigitalOcean Kubernetes.

---
apiVersion: v1
kind: DeploymentContract
metadata:
  name: todo-app-doks-deployment
  version: "1.0.0"

# Infrastructure Requirements
infrastructure:
  provider: digitalocean
  region: nyc1

  cluster:
    name: todo-app-cluster
    version: "1.31"  # Kubernetes version
    node_pool:
      name: default
      size: s-2vcpu-4gb
      count: 1
      auto_scale: false

  registry:
    name: todo-app-registry
    tier: free  # 500MB limit

  cost_budget:
    monthly_max_usd: 30
    target_usd: 24

# Service Exposure
services:
  frontend:
    type: NodePort
    port: 80
    target_port: 3000
    node_port: 30080
    replicas: 1

  backend:
    type: ClusterIP
    port: 8000
    target_port: 8000
    replicas: 1

# Resource Constraints
resources:
  frontend:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

  backend:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# Image Configuration
images:
  frontend:
    repository: registry.digitalocean.com/todo-app-registry/frontend
    tag_strategy: git_sha  # Uses commit SHA for versioning
    pull_policy: Always

  backend:
    repository: registry.digitalocean.com/todo-app-registry/backend
    tag_strategy: git_sha
    pull_policy: Always

# Secrets (values provided at deployment time)
secrets:
  required:
    - name: DATABASE_URL
      description: Neon PostgreSQL connection string
      source: github_secret

    - name: BETTER_AUTH_SECRET
      description: JWT signing secret for authentication
      source: github_secret

    - name: OPENAI_API_KEY
      description: OpenAI API key for chatbot
      source: github_secret

    - name: DIGITALOCEAN_ACCESS_TOKEN
      description: DO API token for deployment
      source: github_secret

# CI/CD Configuration
cicd:
  platform: github_actions
  trigger:
    - event: push
      branch: main
    - event: workflow_dispatch

  stages:
    - name: build
      actions:
        - checkout
        - docker_build_frontend
        - docker_build_backend

    - name: push
      actions:
        - registry_login
        - docker_push_frontend
        - docker_push_backend

    - name: deploy
      actions:
        - kubectl_config
        - helm_upgrade

# Health Checks
health:
  frontend:
    readiness:
      path: /api/health
      port: 3000
      initial_delay_seconds: 15
    liveness:
      path: /api/health
      port: 3000
      initial_delay_seconds: 30

  backend:
    readiness:
      path: /api/health
      port: 8000
      initial_delay_seconds: 10
    liveness:
      path: /api/health
      port: 8000
      initial_delay_seconds: 20

# Acceptance Criteria Mapping
acceptance:
  SC-001:
    description: "Application accessible within 10 minutes"
    verification: "curl http://<NODE_IP>:30080 returns 200"

  SC-002:
    description: "Automated deployment within 10 minutes"
    verification: "GitHub Actions workflow completes successfully"

  SC-003:
    description: "Monthly cost < $30"
    verification: "DigitalOcean billing shows < $30"

  SC-004:
    description: "Response time < 3 seconds"
    verification: "Manual browser testing shows acceptable performance"

  SC-005:
    description: "Zero code changes to Phase 4"
    verification: "git diff phase-4-kubernetes-deployment phase-5-cloud shows no app code changes"

  SC-006:
    description: "Manual and automated deployment"
    verification: "deploy.sh script and GitHub Actions both work"
